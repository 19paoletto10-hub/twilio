{% extends "base.html" %}
{% block title %}Rozmowa z {{ display_number or 'kontaktem' }} | Twilio{% endblock %}

{% block sidebar %}
  <aside class="app-sidebar" data-app-sidebar>
    <div>
      <div class="app-sidebar__section-title mb-3">Nawigacja</div>
      <nav class="app-sidebar__nav" aria-label="Widoki">
        <a class="app-sidebar__link" href="/">
          <i class="bi bi-speedometer2"></i>
          <span class="app-sidebar__label">Panel główny</span>
        </a>
        <a class="app-sidebar__link is-active" href="#chat-root" data-chat-scroll>
          <i class="bi bi-chat-dots"></i>
          <span class="app-sidebar__label">Bieżąca rozmowa</span>
        </a>
      </nav>
    </div>
    <div>
      <div class="app-sidebar__section-title mb-3">Akcje</div>
      <nav class="app-sidebar__nav" aria-label="Akcje rozmowy">
        <a class="app-sidebar__link" href="#chat-thread" data-chat-scroll>
          <i class="bi bi-journal-text"></i>
          <span class="app-sidebar__label">Historia wiadomości</span>
        </a>
        <a class="app-sidebar__link" href="#chat-send-form" data-chat-scroll>
          <i class="bi bi-pencil-square"></i>
          <span class="app-sidebar__label">Napisz odpowiedź</span>
        </a>
        <a class="app-sidebar__link" href="https://console.twilio.com/" target="_blank" rel="noreferrer">
          <i class="bi bi-box-arrow-up-right"></i>
          <span class="app-sidebar__label">Twilio Console</span>
        </a>
      </nav>
    </div>
  </aside>
{% endblock %}

{% block content %}
  <div
    class="container-fluid chat-page px-lg-4"
    id="chat-root"
    data-participant="{{ participant|e }}"
  >
    <div class="chat-page-header mb-4">
      <div class="d-flex flex-wrap align-items-center justify-content-between gap-3">
        <div class="d-flex align-items-center gap-3">
          <a class="btn btn-outline-secondary btn-sm" href="/" title="Powrót">
            <i class="bi bi-arrow-left"></i>
          </a>
          <div class="chat-page-header__avatar">
            <i class="bi bi-person-fill"></i>
          </div>
          <div>
            <h1 class="h5 fw-semibold mb-0">{{ display_number or 'Nieznany numer' }}</h1>
            <small class="text-muted">Rozmowa SMS</small>
          </div>
        </div>
        <div class="d-flex align-items-center gap-2 flex-wrap">
          <span class="badge bg-success-subtle text-success-emphasis px-2 py-1">
            <i class="bi bi-circle-fill me-1" style="font-size:0.5rem"></i>Online
          </span>
          <span class="badge bg-secondary-subtle text-secondary-emphasis px-2 py-1">
            {{ app_env|upper }}
          </span>
        </div>
      </div>
    </div>

    <div class="row chat-layout g-4">
      <aside class="col-xl-4">
        <div class="card shadow-sm border-0 chat-sidebar-card">
          <div class="card-header bg-transparent border-0 pb-0 pt-3 px-3">
            <div class="d-flex align-items-center justify-content-between gap-2">
              <div class="d-flex align-items-center gap-2">
                <span class="chat-avatar">
                  <i class="bi bi-person-fill"></i>
                </span>
                <div>
                  <h2 class="h6 mb-0 fw-semibold">{{ display_number or 'Nieznany' }}</h2>
                  <small class="text-muted">SMS / MMS</small>
                </div>
              </div>
              <button
                class="btn btn-light btn-sm d-inline-flex align-items-center gap-1 d-xl-none"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#chat-sidebar-details"
                aria-expanded="false"
                aria-controls="chat-sidebar-details"
              >
                <i class="bi bi-chevron-down"></i>
              </button>
            </div>
          </div>
          <div class="card-body px-3 pt-3">
            <div class="collapse d-xl-block" id="chat-sidebar-details">
              <div class="chat-meta-grid mb-3">
                <div class="chat-meta-item">
                  <i class="bi bi-clock text-primary"></i>
                  <div>
                    <small class="text-muted d-block">Ostatnia aktywność</small>
                    <span class="fw-medium" id="chat-last-updated">—</span>
                  </div>
                </div>
                <div class="chat-meta-item">
                  <i class="bi bi-chat-square-text text-success"></i>
                  <div>
                    <small class="text-muted d-block">Wiadomości</small>
                    <span class="fw-bold fs-5" id="chat-total-messages">0</span>
                  </div>
                </div>
              </div>
              <div class="alert alert-light border-0 small mb-3 py-2 px-3" role="alert">
                <i class="bi bi-info-circle text-primary me-1"></i>
                Wątek odświeża się automatycznie.
              </div>
              <div class="chat-sidebar__actions d-grid gap-2">
                <button type="button" class="btn btn-outline-secondary d-flex align-items-center justify-content-center gap-2" id="chat-refresh-btn">
                  <i class="bi bi-arrow-clockwise"></i> Odśwież teraz
                </button>
                <a class="btn btn-outline-primary d-flex align-items-center justify-content-center gap-2" href="https://console.twilio.com/" target="_blank" rel="noreferrer">
                  <i class="bi bi-box-arrow-up-right"></i> Twilio Console
                </a>
                <button type="button" class="btn btn-outline-danger d-flex align-items-center justify-content-center gap-2" id="chat-delete-conversation-btn">
                  <i class="bi bi-trash3"></i> Usuń rozmowę
                </button>
              </div>
              <p class="text-muted small mt-3 mb-0 text-center">
                <i class="bi bi-exclamation-triangle text-warning me-1"></i>
                Usunięcie jest nieodwracalne.
              </p>
            </div>
          </div>
        </div>
      </aside>

      <section class="col-xl-8">
        <div class="card shadow-sm border-0 chat-shell h-100">
          <div class="card-body p-0 d-flex flex-column h-100">
            <div class="chat-header border-bottom px-3 py-2">
              <div class="d-flex justify-content-between align-items-center gap-2 flex-wrap">
                <div class="d-flex align-items-center gap-2">
                  <span class="chat-header-icon">
                    <i class="bi bi-chat-dots-fill"></i>
                  </span>
                  <div>
                    <h2 class="h6 mb-0 fw-semibold">{{ display_number or 'Nieznany' }}</h2>
                    <small class="text-muted d-flex align-items-center gap-1">
                      <i class="bi bi-clock"></i>
                      <span id="chat-last-updated-inline">—</span>
                    </small>
                  </div>
                </div>
                <div class="chat-toolbar d-flex gap-2">
                  <button type="button" class="btn btn-light btn-sm d-flex align-items-center gap-1" id="chat-refresh-btn-inline" title="Odśwież">
                    <i class="bi bi-arrow-clockwise"></i>
                    <span class="d-none d-md-inline">Odśwież</span>
                  </button>
                  <button type="button" class="btn btn-light btn-sm d-flex align-items-center gap-1 d-xl-none" data-bs-toggle="collapse" data-bs-target="#chat-sidebar-details" aria-controls="chat-sidebar-details" title="Szczegóły">
                    <i class="bi bi-info-circle"></i>
                  </button>
                </div>
              </div>
            </div>
            <div class="chat-thread-wrapper position-relative flex-grow-1">
              <div class="chat-thread" id="chat-thread" tabindex="0" aria-live="polite">
                <div class="chat-loading-state text-center text-muted py-5">
                  <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
                  <span>Wczytywanie historii...</span>
                </div>
              </div>
              <button type="button" class="btn btn-primary btn-sm chat-scroll-latest is-hidden d-flex align-items-center gap-1" id="chat-scroll-latest-btn">
                <i class="bi bi-chevron-double-down"></i> Na dół
              </button>
            </div>
            <div class="chat-composer border-top">
              <form id="chat-send-form" class="chat-composer-form p-3" novalidate>
                <div class="chat-composer-input-wrap">
                  <textarea class="form-control chat-composer-textarea" id="chat-message-input" rows="2" maxlength="1000" placeholder="Napisz wiadomość..." required></textarea>
                  <div class="invalid-feedback">Treść wiadomości jest wymagana.</div>
                </div>
                <div class="d-flex justify-content-between align-items-center mt-2 flex-wrap gap-2">
                  <div class="d-flex align-items-center gap-2 text-muted small">
                    <i class="bi bi-person-check"></i>
                    <span>Do: <strong>{{ participant }}</strong></span>
                  </div>
                  <span class="badge bg-light text-muted" id="chat-message-counter" data-max="1000">0 / 1000</span>
                </div>
                <div class="d-flex justify-content-end align-items-center mt-3 gap-2">
                  <button type="button" class="btn btn-light d-flex align-items-center gap-1" id="chat-clear-btn">
                    <i class="bi bi-x-lg"></i> Wyczyść
                  </button>
                  <button type="submit" class="btn btn-primary d-flex align-items-center gap-2" id="chat-send-btn">
                    <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                    <i class="bi bi-send-fill"></i> Wyślij
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </section>
    </div>

    <div class="toast-container position-fixed bottom-0 end-0 p-3" id="chat-toast-wrapper"></div>
  </div>
{% endblock %}

{% block scripts %}
  <script src="{{ url_for('static', filename='js/chat.js') }}" defer></script>
{% endblock %}
