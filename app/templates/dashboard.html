{% extends "base.html" %}
{% block title %}Panel czatu | Twilio{% endblock %}

{% block sidebar %}
  <aside class="app-sidebar" data-app-sidebar>
    <div>
      <div class="app-sidebar__section-title mb-3">Panel sterowania</div>
      <nav class="app-sidebar__nav" aria-label="Nawigacja główna">
        <a
          class="app-sidebar__link is-active"
          href="#tab-messages"
          data-dashboard-nav="tab-messages"
        >
          <i class="bi bi-chat-dots"></i>
          <span class="app-sidebar__label">Wiadomości</span>
        </a>
        <a class="app-sidebar__link" href="#tab-auto-reply" data-dashboard-nav="tab-auto-reply">
          <i class="bi bi-arrow-repeat"></i>
          <span class="app-sidebar__label">Auto-odpowiedź</span>
        </a>
        <a class="app-sidebar__link" href="#tab-reminders" data-dashboard-nav="tab-reminders">
          <i class="bi bi-stopwatch"></i>
          <span class="app-sidebar__label">Przypomnienia</span>
        </a>
        <a class="app-sidebar__link" href="#tab-ai" data-dashboard-nav="tab-ai">
          <i class="bi bi-stars"></i>
          <span class="app-sidebar__label">AI</span>
        </a>
        <a class="app-sidebar__link" href="#tab-news" data-dashboard-nav="tab-news">
          <i class="bi bi-newspaper"></i>
          <span class="app-sidebar__label">News</span>
        </a>
        <a class="app-sidebar__link" href="#tab-listeners" data-dashboard-nav="tab-listeners">
          <i class="bi bi-ear"></i>
          <span class="app-sidebar__label">Listeners</span>
        </a>
        <a class="app-sidebar__link" href="#tab-multi-sms" data-dashboard-nav="tab-multi-sms">
          <i class="bi bi-people"></i>
          <span class="app-sidebar__label">Multi-SMS</span>
        </a>
      </nav>
    </div>
    <div>
      <div class="app-sidebar__section-title mb-3">Szybkie akcje</div>
      <nav class="app-sidebar__nav" aria-label="Szybkie akcje">
        <a class="app-sidebar__link" href="#sendMessageModal" role="button" data-dashboard-modal-target="#sendMessageModal">
          <i class="bi bi-send"></i>
          <span class="app-sidebar__label">Wyślij nową wiadomość</span>
        </a>
        <a class="app-sidebar__link" href="#messages-table" data-dashboard-scroll>
          <i class="bi bi-chat-text"></i>
          <span class="app-sidebar__label">Historia konwersacji</span>
        </a>
        <a class="app-sidebar__link" href="#" data-dashboard-refresh>
          <i class="bi bi-arrow-clockwise"></i>
          <span class="app-sidebar__label">Odśwież dane</span>
        </a>
      </nav>
    </div>
  </aside>
{% endblock %}

{% block content %}
  <div class="container-fluid px-lg-4" id="dashboard-root" data-app-env="{{ app_env }}" data-app-debug="{{ 'true' if app_debug else 'false' }}">
    <div class="dashboard-header mb-4">
      <div class="d-flex flex-wrap align-items-center justify-content-between gap-3">
        <div class="d-flex align-items-center gap-3">
          <span class="page-icon-badge">
            <i class="bi bi-grid-1x2-fill"></i>
          </span>
          <div>
            <h1 class="h4 fw-bold mb-0">Panel sterowania</h1>
            <p class="text-muted small mb-0">Zarządzaj rozmowami SMS z jednego miejsca.</p>
          </div>
        </div>
        <div class="d-flex align-items-center gap-2">
          <span class="badge bg-dark px-3 py-2 d-inline-flex align-items-center gap-1">
            <i class="bi bi-server"></i> {{ app_env|upper }}
          </span>
        </div>
      </div>
    </div>

    <ul class="nav nav-pills nav-pills-modern gap-2 mb-4" id="dashboard-tabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active d-flex align-items-center gap-2" id="tab-messages-btn" data-bs-toggle="tab" data-bs-target="#tab-messages" type="button" role="tab" aria-controls="tab-messages" aria-selected="true">
          <i class="bi bi-chat-dots"></i> Wiadomości
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link d-flex align-items-center gap-2" id="tab-auto-reply-btn" data-bs-toggle="tab" data-bs-target="#tab-auto-reply" type="button" role="tab" aria-controls="tab-auto-reply" aria-selected="false">
          <i class="bi bi-arrow-repeat"></i> Auto-odpowiedź
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link d-flex align-items-center gap-2" id="tab-reminders-btn" data-bs-toggle="tab" data-bs-target="#tab-reminders" type="button" role="tab" aria-controls="tab-reminders" aria-selected="false">
          <i class="bi bi-stopwatch"></i> Przypomnienia
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link d-flex align-items-center gap-2" id="tab-ai-btn" data-bs-toggle="tab" data-bs-target="#tab-ai" type="button" role="tab" aria-controls="tab-ai" aria-selected="false">
          <i class="bi bi-stars"></i> AI
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link d-flex align-items-center gap-2" id="tab-news-btn" data-bs-toggle="tab" data-bs-target="#tab-news" type="button" role="tab" aria-controls="tab-news" aria-selected="false">
          <i class="bi bi-newspaper"></i> News
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link d-flex align-items-center gap-2" id="tab-listeners-btn" data-bs-toggle="tab" data-bs-target="#tab-listeners" type="button" role="tab" aria-controls="tab-listeners" aria-selected="false">
          <i class="bi bi-ear"></i> Listeners
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link d-flex align-items-center gap-2" id="tab-multi-sms-btn" data-bs-toggle="tab" data-bs-target="#tab-multi-sms" type="button" role="tab" aria-controls="tab-multi-sms" aria-selected="false">
          <i class="bi bi-people"></i> Multi-SMS
        </button>
      </li>
    </ul>

    <div class="tab-content">
      <div class="tab-pane fade show active" id="tab-messages" role="tabpanel" aria-labelledby="tab-messages-btn" tabindex="0">
        {% if not has_sender_identity %}
          <div class="alert alert-warning d-flex align-items-center" role="alert">
            <div>
              <strong>Brak nadawcy.</strong> Uzupełnij <code>TWILIO_DEFAULT_FROM</code> lub <code>TWILIO_MESSAGING_SERVICE_SID</code>, aby wysyłać wiadomości.
            </div>
          </div>
        {% endif %}

        <div class="row g-3 mb-4" id="stats-cards">
          <div class="col-md-4">
            <div class="card shadow-sm h-100 border-0">
              <div class="card-body">
                <p class="text-uppercase text-muted fs-6 mb-1">Wszystkie wiadomości</p>
                <h2 class="fw-bold mb-0" id="stat-total">0</h2>
                <small class="text-muted">Łączna liczba wiadomości w bazie.</small>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card shadow-sm h-100 border-0">
              <div class="card-body">
                <p class="text-uppercase text-muted fs-6 mb-1">Przychodzące</p>
                <h2 class="fw-bold mb-0 text-success" id="stat-inbound">0</h2>
                <small class="text-muted">Otrzymane od klientów.</small>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card shadow-sm h-100 border-0">
              <div class="card-body">
                <p class="text-uppercase text-muted fs-6 mb-1">Wychodzące</p>
                <h2 class="fw-bold mb-0 text-info" id="stat-outbound">0</h2>
                <small class="text-muted">Wysłane z aplikacji.</small>
              </div>
            </div>
          </div>
        </div>

        <div class="row g-4 align-items-start">
          <div class="col-lg-3">
            <div class="card shadow-sm border-0" id="send-message-card">
              <div class="card-body text-center py-4">
                <div class="d-inline-flex align-items-center justify-content-center rounded-circle bg-primary-subtle mb-3" style="width: 3.5rem; height: 3.5rem;">
                  <i class="bi bi-send-fill fs-4 text-primary"></i>
                </div>
                <h2 class="h6 fw-semibold mb-2">Nowa wiadomość</h2>
                <p class="text-muted small mb-3">Szybko wyślij SMS do dowolnego odbiorcy.</p>
                <button type="button" class="btn btn-primary btn-sm w-100" data-dashboard-modal-target="#sendMessageModal">
                  <i class="bi bi-pencil-square me-1"></i>Utwórz
                </button>
              </div>
            </div>
          </div>

          <div class="col-lg-9">
            <div class="card shadow-sm border-0 messages-card">
              <div class="card-header bg-white border-0 py-3">
                <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-3">
                  <div class="d-flex align-items-center gap-3">
                    <div class="d-inline-flex align-items-center justify-content-center rounded bg-secondary-subtle" style="width: 2.5rem; height: 2.5rem;">
                      <i class="bi bi-chat-text fs-5 text-secondary"></i>
                    </div>
                    <div>
                      <h2 class="h5 mb-0 fw-semibold">Historia wiadomości</h2>
                      <small class="text-muted">Ostatnie 50 · <span id="messages-refresh-status">Auto-odświeżanie co 15s</span></small>
                    </div>
                  </div>
                  <div class="d-flex flex-wrap align-items-center gap-2">
                    <div class="btn-group btn-group-sm" role="group" aria-label="Filtruj">
                      <button type="button" class="btn btn-outline-secondary active" data-filter="all">
                        <i class="bi bi-list-ul me-1 d-none d-md-inline"></i>Wszystkie
                      </button>
                      <button type="button" class="btn btn-outline-secondary" data-filter="inbound">
                        <i class="bi bi-arrow-down-left me-1 d-none d-md-inline"></i>Przychodzące
                      </button>
                      <button type="button" class="btn btn-outline-secondary" data-filter="outbound">
                        <i class="bi bi-arrow-up-right me-1 d-none d-md-inline"></i>Wychodzące
                      </button>
                    </div>
                    <button type="button" class="btn btn-outline-primary btn-sm" id="messages-manual-refresh" title="Odśwież teraz">
                      <i class="bi bi-arrow-clockwise"></i>
                    </button>
                  </div>
                </div>
              </div>
              <div class="card-body p-0">
                <div class="table-responsive messages-table-wrapper">
                  <table class="table table-hover align-middle mb-0 messages-table" id="messages-table">
                    <thead class="table-light sticky-top">
                      <tr>
                        <th scope="col" class="text-nowrap ps-3">Kierunek</th>
                        <th scope="col" class="text-nowrap">Kontakt</th>
                        <th scope="col">Treść</th>
                        <th scope="col" class="text-nowrap">Status</th>
                        <th scope="col" class="text-nowrap text-center">Akcje</th>
                        <th scope="col" class="text-nowrap text-end pe-3">Czas</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td colspan="6" class="text-center text-muted py-5">
                          <div class="d-flex flex-column align-items-center gap-2">
                            <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                            <span>Wczytywanie wiadomości...</span>
                          </div>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
              <div class="card-footer bg-white border-top-0 py-2 px-3">
                <div class="d-flex justify-content-between align-items-center small text-muted">
                  <span id="messages-count-label">Wyświetlono: <strong>0</strong> wiadomości</span>
                  <span id="messages-last-updated">—</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="modal fade" id="sendMessageModal" tabindex="-1" aria-labelledby="sendMessageModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content shadow-lg border-0">
              <div class="modal-header border-0 pb-0">
                <div>
                  <p class="text-uppercase text-muted fs-6 mb-1">Nowa wiadomość</p>
                  <h1 class="modal-title fs-4 fw-semibold" id="sendMessageModalLabel">Wyślij nową wiadomość</h1>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Zamknij"></button>
              </div>
              <div class="modal-body">
                <form id="send-message-form" novalidate>
                  <div class="mb-3">
                    <label for="recipient-input" class="form-label">Numer odbiorcy</label>
                    <input type="tel" class="form-control" id="recipient-input" placeholder="np. +48123456789" required>
                    <div class="invalid-feedback">Podaj poprawny numer odbiorcy.</div>
                  </div>
                  <div class="mb-3">
                    <label for="message-body" class="form-label">Treść wiadomości</label>
                    <textarea class="form-control" id="message-body" rows="4" maxlength="1000" placeholder="Wpisz wiadomość..." required></textarea>
                    <div class="invalid-feedback">Wiadomość nie może być pusta.</div>
                  </div>
                  <div class="d-flex justify-content-end gap-2 pt-2">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Anuluj</button>
                    <button type="submit" class="btn btn-primary" id="send-message-btn">
                      <span class="spinner-border spinner-border-sm me-2 d-none" role="status"></span>
                      Wyślij wiadomość
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="tab-pane fade" id="tab-auto-reply" role="tabpanel" aria-labelledby="tab-auto-reply-btn" tabindex="0">
        <div class="row g-4">
          <div class="col-lg-8">
            <div class="card shadow-sm border-0 h-100">
              <div class="card-header bg-white border-0 pb-0 d-flex flex-wrap justify-content-between align-items-center gap-2">
                <div>
                  <p class="text-uppercase text-muted fs-6 mb-1">Auto-odpowiedź SMS</p>
                  <h2 class="h5 mb-0">Ustaw wiadomość automatyczną</h2>
                </div>
                <span class="badge bg-secondary-subtle text-secondary-emphasis" id="auto-reply-status-badge">Ładowanie...</span>
              </div>
              <div class="card-body">
                <form id="auto-reply-form" novalidate>
                  <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" role="switch" id="auto-reply-enabled">
                    <label class="form-check-label" for="auto-reply-enabled">Włącz automatyczne odpowiadanie na nowe wiadomości</label>
                  </div>

                  <div class="mb-3">
                    <label for="auto-reply-message" class="form-label">Treść wysyłanej wiadomości</label>
                    <textarea class="form-control" id="auto-reply-message" rows="3" maxlength="640" placeholder="Np. Dziękujemy za wiadomość! Wracamy z odpowiedzią wkrótce." required></textarea>
                    <div class="invalid-feedback">Podaj treść auto-odpowiedzi (maks. 640 znaków).</div>
                  </div>

                  <div class="alert alert-info small" role="alert" id="auto-reply-helper">
                    Włączona funkcja wyśle SMS na numer nadawcy każdej nowej wiadomości. Obsługiwane są numery w formacie <code>+48XXXXXXXXX</code>.
                  </div>

                  <div class="d-flex flex-wrap gap-2 align-items-center">
                    <button type="submit" class="btn btn-primary" id="auto-reply-save-btn">
                      <span class="spinner-border spinner-border-sm me-2 d-none" role="status"></span>
                      Zapisz ustawienia
                    </button>
                    <small class="text-muted" id="auto-reply-last-updated">&nbsp;</small>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <div class="col-lg-4">
            <div class="card shadow-sm border-0 h-100">
              <div class="card-body">
                <h2 class="h6 mb-3">Jak to działa?</h2>
                <ul class="list-unstyled small text-muted mb-0">
                  <li class="mb-2">- Aplikacja zapisuje przychodzące wiadomości i wysyła SMS zwrotny, gdy funkcja jest włączona.</li>
                  <li class="mb-2">- Wiadomość jest wysyłana z numeru domyślnego lub Messaging Service (jeśli skonfigurowano).</li>
                  <li class="mb-2">- Kolejka w tle chroni przed duplikatami i obsługuje maks. 1000 ostatnich SID.</li>
                  <li>- Wyłączenie auto-odpowiedzi przywraca tryb odpowiedzi generowanej przez silnik czatu.</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="tab-pane fade" id="tab-reminders" role="tabpanel" aria-labelledby="tab-reminders-btn" tabindex="0">
        <div class="row g-4">
          <div class="col-lg-5">
            <div class="card shadow-sm border-0 h-100">
              <div class="card-header bg-white border-0 pb-0">
                <p class="text-uppercase text-muted fs-6 mb-1">Nowe przypomnienie SMS</p>
                <h2 class="h5 mb-0">Wyślij cyklicznie</h2>
              </div>
              <div class="card-body">
                <form id="reminder-form" novalidate>
                  <div class="mb-3">
                    <label for="reminder-to" class="form-label">Numer odbiorcy</label>
                    <input type="tel" class="form-control" id="reminder-to" placeholder="+48123456789" required>
                    <div class="invalid-feedback">Podaj numer w formacie E.164.</div>
                  </div>
                  <div class="mb-3">
                    <label for="reminder-body" class="form-label">Treść wiadomości</label>
                    <textarea class="form-control" id="reminder-body" rows="3" maxlength="640" placeholder="Napisz treść przypomnienia" required></textarea>
                    <div class="invalid-feedback">Treść jest wymagana.</div>
                  </div>
                  <div class="mb-3">
                    <label for="reminder-interval" class="form-label">Interwał (minuty)</label>
                    <input type="number" min="1" class="form-control" id="reminder-interval" value="60" required>
                    <div class="invalid-feedback">Podaj interwał co najmniej 1 minutę.</div>
                  </div>
                  <button type="submit" class="btn btn-primary w-100" id="reminder-save-btn">
                    <span class="spinner-border spinner-border-sm me-2 d-none" role="status"></span>
                    Zapisz przypomnienie
                  </button>
                </form>
              </div>
            </div>
          </div>

          <div class="col-lg-7">
            <div class="card shadow-sm border-0 h-100">
              <div class="card-header bg-white border-0 d-flex align-items-center justify-content-between">
                <div>
                  <p class="text-uppercase text-muted fs-6 mb-1">Przypomnienia</p>
                  <h2 class="h5 mb-0">Aktywne i zaplanowane</h2>
                </div>
                <span class="badge bg-secondary-subtle text-secondary-emphasis" id="reminder-count-badge">0</span>
              </div>
              <div class="card-body p-0">
                <div class="table-responsive">
                  <table class="table table-hover mb-0" id="reminders-table">
                    <thead class="table-light">
                      <tr>
                        <th scope="col">Numer</th>
                        <th scope="col">Treść</th>
                        <th scope="col" class="text-nowrap">Interwał</th>
                        <th scope="col" class="text-nowrap">Status</th>
                        <th scope="col" class="text-nowrap">Akcje</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td colspan="5" class="text-center text-muted py-4">Brak danych.</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="tab-pane fade" id="tab-ai" role="tabpanel" aria-labelledby="tab-ai-btn" tabindex="0">
        <div class="row g-4">
          <div class="col-12">
            <div class="card shadow-sm border-0">
              <div class="card-header bg-white border-0 pb-0 d-flex justify-content-between align-items-center">
                <div>
                  <p class="text-uppercase text-muted fs-6 mb-1">Integracja z AI</p>
                  <h2 class="h5 mb-0">Konfiguracja OpenAI</h2>
                </div>
                <span class="badge bg-secondary-subtle text-secondary-emphasis" id="ai-status-badge">Wyłączone</span>
              </div>
              <div class="card-body">
                <form id="ai-config-form" novalidate>
                  <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" role="switch" id="ai-enabled">
                    <label class="form-check-label" for="ai-enabled">Włącz automatyczne odpowiedzi AI na wszystkie przychodzące wiadomości</label>
                  </div>

                  <div class="mb-3">
                    <label for="ai-system-prompt" class="form-label">Prompt systemowy</label>
                    <textarea class="form-control" id="ai-system-prompt" rows="3" placeholder="Np. Jesteś asystentem obsługi klienta, który odpowiada krótko i po polsku."></textarea>
                    <div class="form-text">Dynamicznie definiuj rolę i styl asystenta.</div>
                  </div>

                  <div class="row g-3 mb-3">
                    <div class="col-sm-6">
                      <label for="ai-model" class="form-label">Model</label>
                      <input type="text" class="form-control" id="ai-model" placeholder="gpt-4o-mini">
                    </div>
                    <div class="col-sm-6">
                      <label for="ai-temperature" class="form-label">Temperatura</label>
                      <input type="number" step="0.1" min="0" max="2" class="form-control" id="ai-temperature" placeholder="0.7">
                    </div>
                  </div>

                  <div class="mb-3">
                    <label for="ai-api-key" class="form-label">OpenAI API key</label>
                    <input type="password" class="form-control" id="ai-api-key" autocomplete="off" placeholder="sk-...">
                    <div class="form-text" id="ai-api-key-preview">Brak zapisanego klucza.</div>
                  </div>

                  <div class="d-flex flex-wrap gap-2 align-items-center">
                    <button type="submit" class="btn btn-primary" id="ai-save-btn">
                      <span class="spinner-border spinner-border-sm me-2 d-none" role="status"></span>
                      Zapisz konfigurację
                    </button>
                    <small class="text-muted" id="ai-updated-at"></small>
                  </div>
                </form>

                <hr class="my-4">
                <div>
                  <p class="text-uppercase text-muted fs-6 mb-1">Test połączenia</p>
                  <p class="small text-muted mb-3">
                    Wyślij przykładową wiadomość do OpenAI, aby upewnić się, że konfiguracja działa (bez wysyłki SMS).
                    Możesz wkleić klucz API w polu powyżej i użyć go do testu bez zapisywania.
                  </p>

                  <div class="mb-3">
                    <label for="ai-test-message" class="form-label">Wiadomość testowa</label>
                    <textarea class="form-control" id="ai-test-message" rows="2" placeholder="Np. Cześć, to jest test. Jak się masz?"></textarea>
                    <div class="form-text">Zostanie potraktowana jako ostatni komunikat użytkownika w rozmowie.</div>
                  </div>

                  <div class="d-flex flex-wrap gap-2 align-items-center">
                    <button type="button" class="btn btn-outline-primary" id="ai-test-btn">
                      <span class="spinner-border spinner-border-sm me-2 d-none" role="status"></span>
                      Przetestuj połączenie
                    </button>
                    <small class="text-muted" id="ai-test-status">&nbsp;</small>
                  </div>

                  <div class="alert alert-light border mt-3 d-none" id="ai-test-result"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="tab-pane fade" id="tab-news" role="tabpanel" aria-labelledby="tab-news-btn" tabindex="0">
        
        <!-- Nagłówek sekcji z akcjami -->
        <div class="news-section-header mb-4">
          <div class="d-flex flex-wrap justify-content-between align-items-center gap-3">
            <div>
              <h1 class="news-section-title">Baza wiedzy FAISS</h1>
              <p class="news-section-subtitle mb-0">Zarządzaj newsami i bazą wektorową AI</p>
            </div>
            <div class="news-quick-actions">
              <div class="news-action-wrapper">
                <button class="btn btn-primary" id="news-scrape-btn">
                  <span class="spinner-border spinner-border-sm me-2 d-none" role="status" id="news-scrape-spinner"></span>
                  <i class="bi bi-cloud-arrow-down me-1"></i>Pobierz newsy
                </button>
                <!-- Dynamiczny dymek logów -->
                <div class="news-log-bubble d-none" id="news-log-bubble">
                  <div class="news-log-bubble__arrow"></div>
                  <div class="news-log-bubble__header">
                    <div class="news-log-bubble__title">
                      <span class="news-log-bubble__icon"><i class="bi bi-terminal-fill"></i></span>
                      <span>Log operacji</span>
                    </div>
                    <div class="news-log-bubble__actions">
                      <div class="news-log-bubble__status" id="news-log-bubble-status">
                        <span class="news-log-bubble__dot"></span>
                        <span id="news-log-bubble-status-text">Oczekuje</span>
                      </div>
                      <button class="news-log-bubble__toggle" id="news-log-bubble-toggle" title="Zwiń/rozwiń">
                        <i class="bi bi-chevron-up"></i>
                      </button>
                    </div>
                  </div>
                  <div class="news-log-bubble__collapsible" id="news-log-bubble-collapsible">
                    <div class="news-log-bubble__progress">
                      <div class="news-log-bubble__progress-bar" id="news-log-progress-bar"></div>
                    </div>
                    <div class="news-log-bubble__content" id="news-log-bubble-content">
                      <div class="news-log-bubble__message" id="news-log-bubble-message">Gotowy do operacji...</div>
                      <div class="news-log-bubble__categories" id="news-log-bubble-categories"></div>
                    </div>
                    <div class="news-log-bubble__footer">
                      <button class="btn btn-sm btn-outline-danger d-none" id="news-scrape-stop-btn">
                        <i class="bi bi-stop-circle me-1"></i>Zatrzymaj
                      </button>
                      <button class="btn btn-sm btn-ghost" id="news-log-bubble-close">
                        <i class="bi bi-x-lg"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              <button class="btn btn-outline-secondary" id="news-faiss-status-refresh-btn">
                <i class="bi bi-arrow-clockwise"></i>
              </button>
            </div>
          </div>
        </div>

        <!-- Status Bar -->
        <div class="news-status-bar mb-4">
          <div class="news-status-item">
            <span class="news-status-label">Status</span>
            <span class="news-status-badge" id="news-faiss-status-pill">Ładowanie...</span>
          </div>
          <div class="news-status-divider"></div>
          <div class="news-status-item">
            <span class="news-status-label">Wektory</span>
            <span class="news-status-value" id="news-faiss-vectors">0</span>
          </div>
          <div class="news-status-divider"></div>
          <div class="news-status-item">
            <span class="news-status-label">Model</span>
            <span class="news-status-value" id="news-faiss-embedding">—</span>
          </div>
          <div class="news-status-divider"></div>
          <div class="news-status-item">
            <span class="news-status-label">Aktualizacja</span>
            <span class="news-status-value" id="news-faiss-status-updated">—</span>
          </div>
          <div class="news-status-actions ms-auto">
            <button class="btn btn-sm btn-outline-secondary" id="news-faiss-backup-btn" title="Pobierz backup">
              <i class="bi bi-download"></i>
            </button>
            <button class="btn btn-sm btn-outline-secondary" id="news-faiss-restore-btn" title="Wczytaj backup">
              <i class="bi bi-upload"></i>
            </button>
            <input type="file" class="d-none" id="news-faiss-restore-input" accept=".zip">
          </div>
        </div>

        <div class="row g-4">
          <!-- Lewa kolumna: Pliki + Skrapowanie -->
          <div class="col-lg-5">
            <!-- Pobrane pliki -->
            <div class="news-panel mb-4">
              <div class="news-panel-header">
                <h3 class="news-panel-title">
                  <i class="bi bi-folder2 me-2"></i>Pobrane kategorie
                </h3>
                <div class="news-panel-actions">
                  <div class="news-action-wrapper news-action-wrapper--small">
                    <button class="btn btn-sm btn-success" id="news-build-index-btn" title="Zbuduj indeks FAISS">
                      <span class="spinner-border spinner-border-sm d-none" id="news-build-index-spinner"></span>
                      <i class="bi bi-lightning-charge"></i>
                    </button>
                    <!-- Dymek logów dla budowania indeksu -->
                    <div class="news-log-bubble news-log-bubble--compact d-none" id="news-build-log-bubble">
                      <div class="news-log-bubble__arrow"></div>
                      <div class="news-log-bubble__header">
                        <div class="news-log-bubble__title">
                          <span class="news-log-bubble__icon news-log-bubble__icon--success"><i class="bi bi-lightning-charge-fill"></i></span>
                          <span>Budowanie FAISS</span>
                        </div>
                        <div class="news-log-bubble__status" id="news-build-log-status">
                          <span class="news-log-bubble__dot"></span>
                          <span id="news-build-log-status-text">Oczekuje</span>
                        </div>
                      </div>
                      <div class="news-log-bubble__progress">
                        <div class="news-log-bubble__progress-bar" id="news-build-progress-bar"></div>
                      </div>
                      <div class="news-log-bubble__content" id="news-build-log-content">
                        <div class="news-log-bubble__message" id="news-build-log-message">Gotowy...</div>
                        <div class="news-log-bubble__steps" id="news-build-log-steps"></div>
                      </div>
                    </div>
                  </div>
                  <button class="btn btn-sm btn-outline-secondary" id="news-files-refresh-btn" title="Odśwież">
                    <i class="bi bi-arrow-clockwise"></i>
                  </button>
                  <button class="btn btn-sm btn-outline-danger" id="news-files-delete-all-btn" title="Usuń wszystkie">
                    <i class="bi bi-trash3"></i>
                  </button>
                </div>
              </div>
              <div class="news-panel-body">
                <div id="news-files-grid">
                  <div class="news-files-empty-state" id="news-files-empty">
                    <i class="bi bi-inbox"></i>
                    <span>Brak pobranych plików</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Prawa kolumna: Testowanie -->
          <div class="col-lg-7">
            <div class="news-panel news-panel-query">
              <div class="news-panel-header">
                <h3 class="news-panel-title">
                  <i class="bi bi-chat-dots me-2"></i>Testuj zapytania
                </h3>
                <button class="btn btn-sm btn-outline-primary" id="news-faiss-quick-test-btn">
                  <i class="bi bi-lightning me-1"></i>Szybki test
                </button>
              </div>
              <div class="news-panel-body">
                <div class="news-query-input">
                  <textarea class="form-control" id="news-faiss-query" rows="2" placeholder="Zadaj pytanie do bazy newsów..."></textarea>
                  <button type="button" class="btn btn-primary" id="news-faiss-test-btn">
                    <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                    <i class="bi bi-send"></i>
                  </button>
                </div>

                <div class="news-query-options">
                  <label class="news-option-switch">
                    <input type="checkbox" id="news-faiss-allcat">
                    <span class="news-option-slider"></span>
                    <span class="news-option-label">Streszczenie wszystkich kategorii</span>
                  </label>
                </div>

                <div id="news-faiss-result" class="d-none">
                  <div class="news-result-card">
                    <div class="news-result-header">
                      <i class="bi bi-robot"></i>
                      <span>Odpowiedź AI</span>
                      <span class="news-result-meta" id="news-faiss-meta"></span>
                    </div>
                    <div class="news-result-content" id="news-faiss-answer"></div>
                    <!-- Sekcja wysyłania SMS -->
                    <div class="news-sms-section">
                      <span class="news-sms-label"><i class="bi bi-send-fill me-2"></i>Wyślij jako SMS:</span>
                      <input type="tel" class="form-control" id="news-sms-recipient" placeholder="+48..." pattern="\+?[0-9]{9,15}">
                      <button type="button" class="btn btn-info" id="news-sms-send-btn">
                        <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                        <i class="bi bi-chat-dots me-1"></i>Wyślij SMS
                      </button>
                    </div>
                  </div>
                </div>

                <div class="mt-3 d-none" id="news-faiss-snippets">
                  <details class="news-snippets-details">
                    <summary>Źródła (<span id="news-faiss-snippets-count">0</span>)</summary>
                    <div class="news-snippets-list" id="news-faiss-snippets-list"></div>
                  </details>
                </div>
              </div>
              <div class="news-panel-footer">
                <span><i class="bi bi-clock me-1"></i>Ostatnia budowa: <strong id="news-last-build">—</strong></span>
                <span><i class="bi bi-bell me-1"></i>Powiadomienie: <strong id="news-last-notification">—</strong></span>
              </div>
            </div>
          </div>

          <!-- Tabela indeksów -->
          <div class="col-12">
            <div class="news-panel">
              <div class="news-panel-header">
                <h3 class="news-panel-title">
                  <i class="bi bi-database me-2"></i>Indeksy FAISS
                </h3>
                <div class="news-panel-actions">
                  <span class="news-count-badge" id="news-indices-count">0</span>
                  <button class="btn btn-sm btn-outline-secondary" id="news-refresh-indices-btn">
                    <i class="bi bi-arrow-clockwise"></i>
                  </button>
                </div>
              </div>
              <div class="news-panel-body p-0">
                <div class="alert alert-danger m-3 d-none" id="news-indices-error"></div>
                <div class="table-responsive">
                  <table class="table news-table mb-0" id="news-indices-table">
                    <thead>
                      <tr>
                        <th>Nazwa</th>
                        <th>Utworzono</th>
                        <th>Rozmiar</th>
                        <th>Status</th>
                        <th class="text-end">Akcje</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td colspan="5" class="text-center text-muted py-4">Brak indeksów</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Ukryte pola meta -->
        <div class="d-none">
          <span id="news-faiss-chat">—</span>
          <span id="news-faiss-status-meta">—</span>
          <span id="news-faiss-status-size">—</span>
          <span id="news-faiss-backup-status">—</span>
        </div>
      </div>

      <!-- ===================== LISTENERS TAB ===================== -->
      <div class="tab-pane fade" id="tab-listeners" role="tabpanel" aria-labelledby="tab-listeners-btn" tabindex="0">
        <div class="row g-4">
          <!-- Konfiguracja Listeners -->
          <div class="col-lg-6">
            <div class="card shadow-sm border-0 h-100">
              <div class="card-header bg-white border-0 pb-0">
                <p class="text-uppercase text-muted fs-6 mb-1">Konfiguracja</p>
                <h2 class="h5 mb-0">Aktywne nasłuchiwacze</h2>
              </div>
              <div class="card-body">
                <p class="text-muted small mb-4">
                  Listeners to specjalne komendy, które mogą być wysłane przez odbiorców SMS.
                  Gdy wiadomość zaczyna się od określonego prefiksu (np. <code>/news</code>), system automatycznie 
                  przetwarza zapytanie i odsyła odpowiedź na podstawie bazy wiedzy FAISS.
                </p>
                <div id="listeners-list" class="d-flex flex-column gap-3">
                  <div class="text-center text-muted py-4" id="listeners-empty">
                    <i class="bi bi-ear-fill fs-1 d-block mb-2 opacity-50"></i>
                    Ładowanie listy nasłuchiwaczy...
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Test Listener -->
          <div class="col-lg-6">
            <div class="card shadow-sm border-0 h-100">
              <div class="card-header bg-white border-0 pb-0">
                <p class="text-uppercase text-muted fs-6 mb-1">Testowanie</p>
                <h2 class="h5 mb-0">Przetestuj /news</h2>
              </div>
              <div class="card-body">
                <p class="text-muted small mb-3">
                  Symuluj zapytanie /news, aby sprawdzić odpowiedź systemu bez wysyłania SMS-a.
                </p>
                <form id="listener-test-form" novalidate>
                  <div class="mb-3">
                    <label for="listener-test-query" class="form-label">Zapytanie</label>
                    <div class="input-group">
                      <span class="input-group-text">/news</span>
                      <input type="text" class="form-control" id="listener-test-query" 
                             placeholder="np. Jakie są najnowsze wiadomości o rynku?">
                    </div>
                    <div class="form-text">Wprowadź pytanie, które zostanie przekazane do bazy FAISS.</div>
                  </div>
                  <button type="submit" class="btn btn-outline-primary w-100" id="listener-test-btn">
                    <span class="spinner-border spinner-border-sm me-2 d-none" role="status"></span>
                    <i class="bi bi-play-fill me-1"></i> Testuj zapytanie
                  </button>
                </form>

                <div class="mt-4" id="listener-test-result-container" style="display: none;">
                  <div class="d-flex align-items-center gap-2 mb-2">
                    <span class="badge bg-success-subtle text-success-emphasis" id="listener-test-status">
                      <i class="bi bi-check-circle"></i> Sukces
                    </span>
                    <small class="text-muted" id="listener-test-meta"></small>
                  </div>
                  <div class="card bg-light border-0">
                    <div class="card-body">
                      <h6 class="card-subtitle mb-2 text-muted">
                        <i class="bi bi-newspaper me-1"></i> Odpowiedź FAISS
                      </h6>
                      <div id="listener-test-answer" class="listener-answer-content"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Informacje o użyciu -->
          <div class="col-12">
            <div class="card shadow-sm border-0">
              <div class="card-header bg-white border-0 pb-0">
                <p class="text-uppercase text-muted fs-6 mb-1">Jak używać</p>
                <h2 class="h5 mb-0">Instrukcja dla odbiorców SMS</h2>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-4">
                    <div class="d-flex gap-3">
                      <div class="listener-step-icon">
                        <i class="bi bi-1-circle-fill"></i>
                      </div>
                      <div>
                        <h6 class="fw-semibold">Wyślij komendę</h6>
                        <p class="text-muted small mb-0">
                          Rozpocznij wiadomość SMS od <code>/news</code> i dodaj swoje pytanie,
                          np. <code>/news Jakie są najnowsze wiadomości?</code>
                        </p>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="d-flex gap-3">
                      <div class="listener-step-icon">
                        <i class="bi bi-2-circle-fill"></i>
                      </div>
                      <div>
                        <h6 class="fw-semibold">System przetwarza</h6>
                        <p class="text-muted small mb-0">
                          Zapytanie jest analizowane przez bazę wiedzy FAISS, 
                          która wyszukuje najlepiej pasujące artykuły.
                        </p>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="d-flex gap-3">
                      <div class="listener-step-icon">
                        <i class="bi bi-3-circle-fill"></i>
                      </div>
                      <div>
                        <h6 class="fw-semibold">Otrzymaj odpowiedź</h6>
                        <p class="text-muted small mb-0">
                          System generuje odpowiedź na podstawie znalezionych 
                          artykułów i wysyła ją jako SMS.
                        </p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="tab-pane fade" id="tab-multi-sms" role="tabpanel" aria-labelledby="tab-multi-sms-btn" tabindex="0">
        <div class="row g-4">
          <div class="col-lg-5">
            <div class="card shadow-sm border-0 h-100">
              <div class="card-header bg-white border-0 pb-0">
                <p class="text-uppercase text-muted fs-6 mb-1">Wielokrotna wysyłka</p>
                <h2 class="h5 mb-0">Wyślij SMS do wielu odbiorców</h2>
              </div>
              <div class="card-body">
                <form id="multi-sms-form" novalidate>
                  <div class="mb-3">
                    <label for="multi-sms-recipients" class="form-label">Numery odbiorców</label>
                    <textarea class="form-control" id="multi-sms-recipients" rows="5" placeholder="np. +48123123123\n+441234567890" required></textarea>
                    <div class="form-text">Wpisz każdy numer w osobnej linii lub oddziel przecinkiem; duplikaty usuwamy automatycznie.</div>
                    <div class="invalid-feedback">Dodaj co najmniej jeden poprawny numer.</div>
                  </div>
                  <div class="mb-3">
                    <label for="multi-sms-body" class="form-label">Treść wiadomości</label>
                    <textarea class="form-control" id="multi-sms-body" rows="4" maxlength="1200" placeholder="Wiadomość wysyłana do wszystkich odbiorców" required></textarea>
                    <div class="invalid-feedback">Treść wiadomości jest wymagana.</div>
                  </div>
                  <div class="alert alert-light border small mb-3" id="multi-sms-tip">
                    <strong>Wysyłka w tle.</strong> Zadanie trafia do kolejki. Monitoruj postęp po prawej stronie – każdy odbiorca otrzyma swój status.
                  </div>
                  <button type="submit" class="btn btn-primary w-100" id="multi-sms-submit-btn">
                    <span class="spinner-border spinner-border-sm me-2 d-none" role="status"></span>
                    Zainicjuj wysyłkę
                  </button>
                  <div class="small text-muted mt-2" id="multi-sms-limit-note">Limit: 250 odbiorców na zadanie.</div>
                </form>
              </div>
            </div>
          </div>

          <div class="col-lg-7">
            <div class="card shadow-sm border-0 h-100">
              <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center flex-wrap gap-2">
                <div>
                  <p class="text-uppercase text-muted fs-6 mb-1">Historia wysyłek</p>
                  <h2 class="h5 mb-0">Multi-SMS (ostatnie 20)</h2>
                </div>
                <div class="d-flex align-items-center gap-2">
                  <button class="btn btn-outline-secondary btn-sm" id="multi-sms-refresh-btn">Odśwież</button>
                  <span class="badge bg-secondary-subtle text-secondary-emphasis" id="multi-sms-batch-count">0</span>
                </div>
              </div>
              <div class="card-body" id="multi-sms-history">
                <div class="text-center text-muted py-4" id="multi-sms-history-empty">Brak wysyłek Multi-SMS.</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="news-overlay d-none" id="news-file-overlay">
        <div class="news-overlay__backdrop"></div>
        <div class="news-overlay__panel">
          <div class="news-overlay__header">
            <div class="news-overlay__header-info">
              <div class="news-overlay__category-icon" id="news-overlay-icon">
                <i class="bi bi-newspaper"></i>
              </div>
              <div class="news-overlay__title-group">
                <h3 id="news-overlay-title">Kategoria</h3>
                <div class="news-overlay__meta" id="news-overlay-meta">
                  <span class="news-overlay__meta-item"><i class="bi bi-file-text"></i><span id="news-overlay-articles">0</span> artykułów</span>
                  <span class="news-overlay__meta-item"><i class="bi bi-hdd"></i><span id="news-overlay-size">0 KB</span></span>
                  <span class="news-overlay__meta-item"><i class="bi bi-clock"></i><span id="news-overlay-updated">—</span></span>
                </div>
              </div>
            </div>
            <div class="news-overlay__actions">
              <button class="news-overlay__close-btn" id="news-overlay-close-btn" title="Zamknij">
                <i class="bi bi-x-lg"></i>
              </button>
            </div>
          </div>
          <div class="news-overlay__content" id="news-overlay-content">
            <div class="text-center text-muted py-5">
              <i class="bi bi-newspaper fs-1 d-block mb-3 text-muted"></i>
              <p>Wybierz kategorię, aby zobaczyć artykuły.</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="toast-container position-fixed bottom-0 end-0 p-3" id="toast-wrapper"></div>
  </div>
{% endblock %}

{% block scripts %}
  <script>
    window.NEWS_DEFAULT_PROMPT = {{ news_default_prompt|tojson }};
    window.NEWS_ALL_CATEGORIES_PROMPT = {{ news_all_categories_prompt|tojson }};
  </script>
  <script src="{{ url_for('static', filename='js/dashboard.js') }}" defer></script>
{% endblock %}
