{% extends "base.html" %}
{% block title %}Panel czatu | Twilio{% endblock %}

{% block content %}
  <div class="container" id="dashboard-root" data-app-env="{{ app_env }}" data-app-debug="{{ 'true' if app_debug else 'false' }}">
    <div class="row align-items-center mb-4">
      <div class="col-lg-8">
        <h1 class="display-6 fw-semibold text-primary mb-1">Panel czatu</h1>
        <p class="text-muted mb-0">ZarzƒÖdzaj rozmowami SMS z jednego miejsca.</p>
      </div>
      <div class="col-lg-4 text-lg-end mt-3 mt-lg-0">
        <span class="badge bg-secondary-subtle text-secondary-emphasis px-3 py-2">
          ≈örodowisko: <strong class="ms-1">{{ app_env|upper }}</strong>
        </span>
      </div>
    </div>

    <ul class="nav nav-pills gap-2 mb-4" id="dashboard-tabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="tab-messages-btn" data-bs-toggle="tab" data-bs-target="#tab-messages" type="button" role="tab" aria-controls="tab-messages" aria-selected="true">
          Wiadomo≈õci
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tab-auto-reply-btn" data-bs-toggle="tab" data-bs-target="#tab-auto-reply" type="button" role="tab" aria-controls="tab-auto-reply" aria-selected="false">
          Auto-odpowied≈∫
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tab-reminders-btn" data-bs-toggle="tab" data-bs-target="#tab-reminders" type="button" role="tab" aria-controls="tab-reminders" aria-selected="false">
          Przypomnienia
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tab-ai-btn" data-bs-toggle="tab" data-bs-target="#tab-ai" type="button" role="tab" aria-controls="tab-ai" aria-selected="false">
          AI
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tab-news-btn" data-bs-toggle="tab" data-bs-target="#tab-news" type="button" role="tab" aria-controls="tab-news" aria-selected="false">
          News
        </button>
      </li>
    </ul>

    <div class="tab-content">
      <div class="tab-pane fade show active" id="tab-messages" role="tabpanel" aria-labelledby="tab-messages-btn" tabindex="0">
        {% if not has_sender_identity %}
          <div class="alert alert-warning d-flex align-items-center" role="alert">
            <div>
              <strong>Brak nadawcy.</strong> Uzupe≈Çnij <code>TWILIO_DEFAULT_FROM</code> lub <code>TWILIO_MESSAGING_SERVICE_SID</code>, aby wysy≈Çaƒá wiadomo≈õci.
            </div>
          </div>
        {% endif %}

        <div class="row g-3 mb-4" id="stats-cards">
          <div class="col-md-4">
            <div class="card shadow-sm h-100 border-0">
              <div class="card-body">
                <p class="text-uppercase text-muted fs-6 mb-1">Wszystkie wiadomo≈õci</p>
                <h2 class="fw-bold mb-0" id="stat-total">0</h2>
                <small class="text-muted">≈ÅƒÖczna liczba wiadomo≈õci w bazie.</small>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card shadow-sm h-100 border-0">
              <div class="card-body">
                <p class="text-uppercase text-muted fs-6 mb-1">PrzychodzƒÖce</p>
                <h2 class="fw-bold mb-0 text-success" id="stat-inbound">0</h2>
                <small class="text-muted">Otrzymane od klient√≥w.</small>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card shadow-sm h-100 border-0">
              <div class="card-body">
                <p class="text-uppercase text-muted fs-6 mb-1">WychodzƒÖce</p>
                <h2 class="fw-bold mb-0 text-info" id="stat-outbound">0</h2>
                <small class="text-muted">Wys≈Çane z aplikacji.</small>
              </div>
            </div>
          </div>
        </div>

        <div class="row g-4">
          <div class="col-lg-4">
            <div class="card shadow-sm border-0 h-100">
              <div class="card-header bg-white border-0 pb-0">
                <h2 class="h5 mb-0">Wy≈õlij nowƒÖ wiadomo≈õƒá</h2>
              </div>
              <div class="card-body">
                <form id="send-message-form" novalidate>
                  <div class="mb-3">
                    <label for="recipient-input" class="form-label">Numer odbiorcy</label>
                    <input type="tel" class="form-control" id="recipient-input" placeholder="np. +48123456789" required>
                    <div class="invalid-feedback">Podaj poprawny numer odbiorcy.</div>
                  </div>
                  <div class="mb-3">
                    <label for="message-body" class="form-label">Tre≈õƒá wiadomo≈õci</label>
                    <textarea class="form-control" id="message-body" rows="3" maxlength="1000" placeholder="Wpisz wiadomo≈õƒá..." required></textarea>
                    <div class="invalid-feedback">Wiadomo≈õƒá nie mo≈ºe byƒá pusta.</div>
                  </div>
                  <button type="submit" class="btn btn-primary w-100" id="send-message-btn">
                    <span class="spinner-border spinner-border-sm me-2 d-none" role="status"></span>
                    Wy≈õlij wiadomo≈õƒá
                  </button>
                </form>
              </div>
            </div>
          </div>

          <div class="col-lg-8">
            <div class="card shadow-sm border-0">
              <div class="card-header bg-white border-0 d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-2">
                <div>
                  <h2 class="h5 mb-0">Historia wiadomo≈õci</h2>
                  <small class="text-muted">Ostatnie 50 pozycji (auto-od≈õwie≈ºanie co 15 sek.)</small>
                </div>
                <div class="btn-group" role="group" aria-label="Filtruj">
                  <button type="button" class="btn btn-outline-secondary active" data-filter="all">Wszystkie</button>
                  <button type="button" class="btn btn-outline-secondary" data-filter="inbound">PrzychodzƒÖce</button>
                  <button type="button" class="btn btn-outline-secondary" data-filter="outbound">WychodzƒÖce</button>
                </div>
              </div>
              <div class="card-body p-0">
                <div class="table-responsive">
                  <table class="table table-hover mb-0 messages-table" id="messages-table">
                    <thead class="table-light">
                      <tr>
                        <th scope="col" class="text-nowrap">Kierunek</th>
                        <th scope="col" class="text-nowrap">Odbiorca / Nadawca</th>
                        <th scope="col">Tre≈õƒá</th>
                        <th scope="col" class="text-nowrap">Status</th>
                        <th scope="col" class="text-nowrap">Akcje</th>
                        <th scope="col" class="text-nowrap">Czat</th>
                        <th scope="col" class="text-nowrap">Czas</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td colspan="7" class="text-center text-muted py-4">Brak danych. Wczytywanie...</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="tab-pane fade" id="tab-auto-reply" role="tabpanel" aria-labelledby="tab-auto-reply-btn" tabindex="0">
        <div class="row g-4">
          <div class="col-lg-8">
            <div class="card shadow-sm border-0 h-100">
              <div class="card-header bg-white border-0 pb-0 d-flex flex-wrap justify-content-between align-items-center gap-2">
                <div>
                  <p class="text-uppercase text-muted fs-6 mb-1">Auto-odpowied≈∫ SMS</p>
                  <h2 class="h5 mb-0">Ustaw wiadomo≈õƒá automatycznƒÖ</h2>
                </div>
                <span class="badge bg-secondary-subtle text-secondary-emphasis" id="auto-reply-status-badge">≈Åadowanie...</span>
              </div>
              <div class="card-body">
                <form id="auto-reply-form" novalidate>
                  <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" role="switch" id="auto-reply-enabled">
                    <label class="form-check-label" for="auto-reply-enabled">W≈ÇƒÖcz automatyczne odpowiadanie na nowe wiadomo≈õci</label>
                  </div>

                  <div class="mb-3">
                    <label for="auto-reply-message" class="form-label">Tre≈õƒá wysy≈Çanej wiadomo≈õci</label>
                    <textarea class="form-control" id="auto-reply-message" rows="3" maxlength="640" placeholder="Np. Dziƒôkujemy za wiadomo≈õƒá! Wracamy z odpowiedziƒÖ wkr√≥tce." required></textarea>
                    <div class="invalid-feedback">Podaj tre≈õƒá auto-odpowiedzi (maks. 640 znak√≥w).</div>
                  </div>

                  <div class="alert alert-info small" role="alert" id="auto-reply-helper">
                    W≈ÇƒÖczona funkcja wy≈õle SMS na numer nadawcy ka≈ºdej nowej wiadomo≈õci. Obs≈Çugiwane sƒÖ numery w formacie <code>+48XXXXXXXXX</code>.
                  </div>

                  <div class="d-flex flex-wrap gap-2 align-items-center">
                    <button type="submit" class="btn btn-primary" id="auto-reply-save-btn">
                      <span class="spinner-border spinner-border-sm me-2 d-none" role="status"></span>
                      Zapisz ustawienia
                    </button>
                    <small class="text-muted" id="auto-reply-last-updated">&nbsp;</small>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <div class="col-lg-4">
            <div class="card shadow-sm border-0 h-100">
              <div class="card-body">
                <h2 class="h6 mb-3">Jak to dzia≈Ça?</h2>
                <ul class="list-unstyled small text-muted mb-0">
                  <li class="mb-2">- Aplikacja zapisuje przychodzƒÖce wiadomo≈õci i wysy≈Ça SMS zwrotny, gdy funkcja jest w≈ÇƒÖczona.</li>
                  <li class="mb-2">- Wiadomo≈õƒá jest wysy≈Çana z numeru domy≈õlnego lub Messaging Service (je≈õli skonfigurowano).</li>
                  <li class="mb-2">- Kolejka w tle chroni przed duplikatami i obs≈Çuguje maks. 1000 ostatnich SID.</li>
                  <li>- Wy≈ÇƒÖczenie auto-odpowiedzi przywraca tryb odpowiedzi generowanej przez silnik czatu.</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="tab-pane fade" id="tab-reminders" role="tabpanel" aria-labelledby="tab-reminders-btn" tabindex="0">
        <div class="row g-4">
          <div class="col-lg-5">
            <div class="card shadow-sm border-0 h-100">
              <div class="card-header bg-white border-0 pb-0">
                <p class="text-uppercase text-muted fs-6 mb-1">Nowe przypomnienie SMS</p>
                <h2 class="h5 mb-0">Wy≈õlij cyklicznie</h2>
              </div>
              <div class="card-body">
                <form id="reminder-form" novalidate>
                  <div class="mb-3">
                    <label for="reminder-to" class="form-label">Numer odbiorcy</label>
                    <input type="tel" class="form-control" id="reminder-to" placeholder="+48123456789" required>
                    <div class="invalid-feedback">Podaj numer w formacie E.164.</div>
                  </div>
                  <div class="mb-3">
                    <label for="reminder-body" class="form-label">Tre≈õƒá wiadomo≈õci</label>
                    <textarea class="form-control" id="reminder-body" rows="3" maxlength="640" placeholder="Napisz tre≈õƒá przypomnienia" required></textarea>
                    <div class="invalid-feedback">Tre≈õƒá jest wymagana.</div>
                  </div>
                  <div class="mb-3">
                    <label for="reminder-interval" class="form-label">Interwa≈Ç (minuty)</label>
                    <input type="number" min="1" class="form-control" id="reminder-interval" value="60" required>
                    <div class="invalid-feedback">Podaj interwa≈Ç co najmniej 1 minutƒô.</div>
                  </div>
                  <button type="submit" class="btn btn-primary w-100" id="reminder-save-btn">
                    <span class="spinner-border spinner-border-sm me-2 d-none" role="status"></span>
                    Zapisz przypomnienie
                  </button>
                </form>
              </div>
            </div>
          </div>

          <div class="col-lg-7">
            <div class="card shadow-sm border-0 h-100">
              <div class="card-header bg-white border-0 d-flex align-items-center justify-content-between">
                <div>
                  <p class="text-uppercase text-muted fs-6 mb-1">Przypomnienia</p>
                  <h2 class="h5 mb-0">Aktywne i zaplanowane</h2>
                </div>
                <span class="badge bg-secondary-subtle text-secondary-emphasis" id="reminder-count-badge">0</span>
              </div>
              <div class="card-body p-0">
                <div class="table-responsive">
                  <table class="table table-hover mb-0" id="reminders-table">
                    <thead class="table-light">
                      <tr>
                        <th scope="col">Numer</th>
                        <th scope="col">Tre≈õƒá</th>
                        <th scope="col" class="text-nowrap">Interwa≈Ç</th>
                        <th scope="col" class="text-nowrap">Status</th>
                        <th scope="col" class="text-nowrap">Akcje</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td colspan="5" class="text-center text-muted py-4">Brak danych.</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="tab-pane fade" id="tab-ai" role="tabpanel" aria-labelledby="tab-ai-btn" tabindex="0">
        <div class="row g-4">
          <div class="col-lg-5">
            <div class="card shadow-sm border-0 h-100">
              <div class="card-header bg-white border-0 pb-0 d-flex justify-content-between align-items-center">
                <div>
                  <p class="text-uppercase text-muted fs-6 mb-1">Integracja z AI</p>
                  <h2 class="h5 mb-0">Konfiguracja OpenAI</h2>
                </div>
                <span class="badge bg-secondary-subtle text-secondary-emphasis" id="ai-status-badge">Wy≈ÇƒÖczone</span>
              </div>
              <div class="card-body">
                <form id="ai-config-form" novalidate>
                  <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" role="switch" id="ai-enabled">
                    <label class="form-check-label" for="ai-enabled">W≈ÇƒÖcz prowadzenie rozmowy z wybranym numerem przez AI</label>
                  </div>

                  <div class="mb-3">
                    <label for="ai-target-number" class="form-label">Numer uczestnika rozmowy</label>
                    <input type="tel" class="form-control" id="ai-target-number" placeholder="np. +48123456789">
                    <div class="form-text">Wszystkie nowe wiadomo≈õci z tego numeru bƒôdƒÖ obs≈Çugiwane przez AI.</div>
                  </div>

                  <div class="mb-3">
                    <label for="ai-system-prompt" class="form-label">Prompt systemowy</label>
                    <textarea class="form-control" id="ai-system-prompt" rows="3" placeholder="Np. Jeste≈õ asystentem obs≈Çugi klienta, kt√≥ry odpowiada kr√≥tko i po polsku."></textarea>
                    <div class="form-text">Dynamicznie definiuj rolƒô i styl asystenta.</div>
                  </div>

                  <div class="row g-3 mb-3">
                    <div class="col-sm-6">
                      <label for="ai-model" class="form-label">Model</label>
                      <input type="text" class="form-control" id="ai-model" placeholder="gpt-4o-mini">
                    </div>
                    <div class="col-sm-6">
                      <label for="ai-temperature" class="form-label">Temperatura</label>
                      <input type="number" step="0.1" min="0" max="2" class="form-control" id="ai-temperature" placeholder="0.7">
                    </div>
                  </div>

                  <div class="mb-3">
                    <label for="ai-api-key" class="form-label">OpenAI API key</label>
                    <input type="password" class="form-control" id="ai-api-key" autocomplete="off" placeholder="sk-...">
                    <div class="form-text" id="ai-api-key-preview">Brak zapisanego klucza.</div>
                  </div>

                  <div class="d-flex flex-wrap gap-2 align-items-center">
                    <button type="submit" class="btn btn-primary" id="ai-save-btn">
                      <span class="spinner-border spinner-border-sm me-2 d-none" role="status"></span>
                      Zapisz konfiguracjƒô
                    </button>
                    <small class="text-muted" id="ai-updated-at"></small>
                  </div>
                </form>

                <hr class="my-4">
                <div>
                  <p class="text-uppercase text-muted fs-6 mb-1">Test po≈ÇƒÖczenia</p>
                  <p class="small text-muted mb-3">
                    Wy≈õlij przyk≈ÇadowƒÖ wiadomo≈õƒá tylko do OpenAI, aby upewniƒá siƒô, ≈ºe konfiguracja dzia≈Ça (bez wysy≈Çki SMS).
                    Gdy pozostawisz pole puste, u≈ºyjemy ostatniej wiadomo≈õci otrzymanej od numeru obs≈Çugiwanego przez AI.
                    Mo≈ºesz wkleiƒá klucz API w polu powy≈ºej i u≈ºyƒá go do testu bez zapisywania.
                  </p>

                  <div class="mb-3">
                    <label for="ai-test-message" class="form-label">Wiadomo≈õƒá testowa</label>
                    <textarea class="form-control" id="ai-test-message" rows="2" placeholder="Np. Cze≈õƒá, to jest test. Jak siƒô masz?"></textarea>
                    <div class="form-text">Zostanie potraktowana jako ostatni komunikat u≈ºytkownika w rozmowie.</div>
                  </div>

                  <div class="d-flex flex-wrap gap-2 align-items-center">
                    <button type="button" class="btn btn-outline-primary" id="ai-test-btn">
                      <span class="spinner-border spinner-border-sm me-2 d-none" role="status"></span>
                      Przetestuj po≈ÇƒÖczenie
                    </button>
                    <small class="text-muted" id="ai-test-status">&nbsp;</small>
                  </div>

                  <div class="alert alert-light border mt-3 d-none" id="ai-test-result"></div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-lg-7">
            <div class="card shadow-sm border-0 h-100">
              <div class="card-header bg-white border-0 pb-0">
                <p class="text-uppercase text-muted fs-6 mb-1">PodglƒÖd konwersacji</p>
                <h2 class="h5 mb-0">Historia czatu z AI</h2>
              </div>
              <div class="card-body d-flex flex-column chat-shell">
                <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap gap-2">
                  <div class="small text-muted">
                    Rozmowa z:
                    <strong id="ai-conversation-participant">Brak skonfigurowanego numeru</strong>
                  </div>
                  <div class="small">
                    <span class="badge bg-light text-muted border">Tryb tylko do podglƒÖdu</span>
                  </div>
                </div>
                <div class="small text-muted mb-2">
                  Wy≈õwietlane sƒÖ wiadomo≈õci z historii rozmowy z wybranym numerem obs≈Çugiwanym przez AI. Nowe wpisy pojawiajƒÖ siƒô automatycznie po zapisaniu konfiguracji.
                </div>
                <div id="ai-conversation" class="chat-thread chat-thread--ai">
                  <div class="text-center text-muted py-4">Brak danych. Skonfiguruj AI i wybierz numer rozm√≥wcy.</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="tab-pane fade" id="tab-news" role="tabpanel" aria-labelledby="tab-news-btn" tabindex="0">
        <div class="row g-4">
          <div class="col-12">
            <div class="card shadow-sm border-0">
              <div class="card-header bg-white border-0 pb-0 d-flex flex-wrap justify-content-between align-items-center gap-2">
                <div>
                  <p class="text-uppercase text-muted fs-6 mb-1">FAISS + OpenAI</p>
                  <h2 class="h5 mb-0">Status bazy wiedzy</h2>
                </div>
                <div class="d-flex flex-wrap gap-2">
                  <button class="btn btn-outline-secondary btn-sm" id="news-faiss-status-refresh-btn">Od≈õwie≈º status</button>
                  <button class="btn btn-outline-primary btn-sm" id="news-faiss-quick-test-btn">Szybki test</button>
                  <button class="btn btn-outline-secondary btn-sm" id="news-faiss-backup-btn">Pobierz backup</button>
                  <button class="btn btn-outline-secondary btn-sm" id="news-faiss-restore-btn">Wczytaj backup</button>
                  <input type="file" class="d-none" id="news-faiss-restore-input" accept=".zip">
                </div>
                <small class="text-muted d-block mt-2" id="news-faiss-backup-status">Backup: oczekiwanie...</small>
              </div>
              <div class="card-body">
                <div class="row g-3 align-items-center">
                  <div class="col-md-4">
                    <div class="d-flex align-items-center gap-2 mb-2">
                      <span class="badge bg-secondary-subtle text-secondary-emphasis" id="news-faiss-status-pill">≈Åadowanie...</span>
                      <small class="text-muted" id="news-faiss-status-updated">‚Äî</small>
                    </div>
                    <div class="small text-muted" id="news-faiss-status-meta">≈öcie≈ºka: ‚Äî</div>
                    <div class="small text-muted" id="news-faiss-status-size">Rozmiar: ‚Äî</div>
                  </div>
                  <div class="col-md-4">
                    <ul class="list-unstyled small mb-0">
                      <li>Embedding: <strong id="news-faiss-embedding">‚Äî</strong></li>
                      <li>Chat model: <strong id="news-faiss-chat">‚Äî</strong></li>
                      <li>Wektory w indeksie: <strong id="news-faiss-vectors">0</strong></li>
                    </ul>
                  </div>
                  <div class="col-md-4 text-md-end">
                    <div class="small text-muted">Plik indeksu: <span id="news-faiss-index-path">‚Äî</span></div>
                    <div class="small text-muted">Snapshot dokument√≥w: <span id="news-faiss-snapshot">‚Äî</span></div>
                  </div>
                </div>
                <div class="alert alert-danger d-none mt-3" id="news-faiss-status-error"></div>
              </div>
            </div>
          </div>

          <div class="col-lg-6">
            <div class="card shadow-sm border-0 h-100">
              <div class="card-header bg-white border-0 pb-0">
                <p class="text-uppercase text-muted fs-6 mb-1">News / RAG</p>
                <h2 class="h5 mb-0">Dodaj odbiorce powiadomie≈Ñ</h2>
              </div>
              <div class="card-body">
                <form id="news-add-recipient-form" novalidate>
                  <div class="mb-3">
                    <label for="news-recipient-phone" class="form-label">Numer telefonu</label>
                    <input type="tel" class="form-control" id="news-recipient-phone" placeholder="np. +48123456789" required>
                    <div class="invalid-feedback">Podaj numer w formacie E.164.</div>
                  </div>

                  <div class="mb-3">
                    <label for="news-recipient-time" class="form-label">Godzina wysy≈Çki (24h)</label>
                    <input type="time" class="form-control" id="news-recipient-time" value="08:00" required>
                    <div class="form-text">Powiadomienie zostanie wys≈Çane o wybranej godzinie</div>
                  </div>

                  <div class="mb-3">
                    <label for="news-recipient-prompt" class="form-label">Prompt dla AI</label>
                    <textarea class="form-control" id="news-recipient-prompt" rows="3" placeholder="np. Wygeneruj kr√≥tkie podsumowanie najwa≈ºniejszych news√≥w ekonomicznych..." required></textarea>
                    <div class="form-text">Opisz jak AI ma wygenerowaƒá wiadomo≈õƒá</div>
                  </div>

                  <button type="submit" class="btn btn-primary">
                    <span class="spinner-border spinner-border-sm me-2 d-none" id="news-add-spinner"></span>
                    Dodaj odbiorce
                  </button>
                </form>
              </div>
            </div>
          </div>

          <div class="col-lg-6">
            <div class="card shadow-sm border-0 h-100">
              <div class="card-header bg-white border-0 pb-0 d-flex justify-content-between align-items-center">
                <div>
                  <p class="text-uppercase text-muted fs-6 mb-1">Mened≈ºer</p>
                  <h2 class="h5 mb-0">Aktywni odbiorcy (<span id="news-recipients-count">0</span>)</h2>
                </div>
                <button class="btn btn-sm btn-outline-secondary" id="news-recipients-refresh-btn">
                  <i class="bi bi-arrow-clockwise"></i>
                </button>
              </div>
              <div class="card-body">
                <div id="news-recipients-list">
                  <p class="text-muted text-center py-4">Brak odbiorc√≥w</p>
                </div>
              </div>
            </div>
          </div>

          <div class="col-lg-7">
            <div class="card shadow-sm border-0 h-100">
              <div class="card-header bg-white border-0 pb-0">
                <p class="text-uppercase text-muted fs-6 mb-1">Test FAISS</p>
                <h2 class="h5 mb-0">Testuj zapytania do bazy news√≥w</h2>
              </div>
              <div class="card-body">
                <p class="small text-muted">Zadaj pytanie do bazy FAISS aby sprawdziƒá jak AI odpowiada na podstawie zeskrapowanych news√≥w.</p>
                
                <div class="mb-3">
                  <label for="news-faiss-query" class="form-label">Zapytanie testowe</label>
                  <textarea class="form-control" id="news-faiss-query" rows="3" placeholder="np. Jakie sƒÖ najwa≈ºniejsze informacje ekonomiczne?"></textarea>
                  <div class="form-text">Wpisz pytanie lub prompt, a AI wygeneruje odpowied≈∫ na podstawie news√≥w.</div>
                </div>

                <div class="d-flex flex-wrap gap-2 align-items-center mb-3">
                  <button type="button" class="btn btn-success" id="news-faiss-test-btn">
                    <span class="spinner-border spinner-border-sm me-2 d-none" role="status"></span>
                    Testuj FAISS
                  </button>
                </div>

                <div id="news-faiss-result" class="d-none">
                  <div class="card bg-light border-0">
                    <div class="card-body">
                      <p class="text-muted small mb-2">Odpowied≈∫ AI:</p>
                      <div id="news-faiss-answer" class="text-dark" style="white-space: pre-wrap;"></div>
                      <div class="mt-2 small text-muted">
                        <span id="news-faiss-meta"></span>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="mt-3 d-none" id="news-faiss-snippets">
                  <p class="text-muted small mb-2">Fragmenty u≈ºyte w odpowiedzi:</p>
                  <div class="list-group small" id="news-faiss-snippets-list"></div>
                </div>

                <div class="mt-3 small text-muted">
                  <div>Ostatnia budowa: <span id="news-last-build">‚Äî</span></div>
                  <div>Ostatnie powiadomienie: <span id="news-last-notification">‚Äî</span></div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-lg-5">
            <div class="card shadow-sm border-0 h-100">
              <div class="card-header bg-white border-0 pb-0">
                <p class="text-uppercase text-muted fs-6 mb-1">Skrapowanie + FAISS</p>
                <h2 class="h5 mb-0">Uruchom pobieranie news√≥w</h2>
              </div>
              <div class="card-body">
                <p class="small text-muted mb-3">Kliknij, aby pobraƒá kategorie Business Insider, zapisaƒá pliki i odbudowaƒá bazƒô FAISS.</p>
                <div class="d-flex align-items-center gap-2 mb-3">
                  <button class="btn btn-success" id="news-scrape-btn">
                    <span class="spinner-border spinner-border-sm me-2 d-none" role="status" id="news-scrape-spinner"></span>
                    Pobierz i zbuduj
                  </button>
                  <span class="badge bg-light text-muted border" id="news-scrape-status">Oczekuje</span>
                </div>
                <div class="alert alert-light border small d-none" id="news-scrape-log"></div>
              </div>
            </div>
          </div>

          <div class="col-lg-7">
            <div class="card shadow-sm border-0 h-100">
              <div class="card-header bg-white border-0 pb-0 d-flex justify-content-between align-items-center">
                <div>
                  <p class="text-uppercase text-muted fs-6 mb-1">Zapisane pliki</p>
                  <h2 class="h5 mb-0">Kategorie po skrapowaniu</h2>
                </div>
                <div class="d-flex gap-2">
                  <button class="btn btn-success btn-sm" id="news-build-index-btn" title="Zbuduj indeks FAISS z istniejƒÖcych plik√≥w">
                    <span class="spinner-border spinner-border-sm me-1 d-none" role="status" id="news-build-index-spinner"></span>
                    üî® Zbuduj Indeks FAISS
                  </button>
                  <button class="btn btn-outline-secondary btn-sm" id="news-files-refresh-btn">Od≈õwie≈º</button>
                </div>
              </div>
              <div class="card-body">
                <div class="row g-3" id="news-files-grid">
                  <div class="col-12 text-center text-muted py-4" id="news-files-empty">Brak plik√≥w. Uruchom skrapowanie, aby zobaczyƒá kafelki.</div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-12">
            <div class="card shadow-sm border-0">
              <div class="card-header bg-white border-0 pb-0 d-flex justify-content-between align-items-center">
                <div>
                  <p class="text-uppercase text-muted fs-6 mb-1">Bazy FAISS</p>
                  <h2 class="h5 mb-0">Wybierz aktywnƒÖ bazƒô / podglƒÖd</h2>
                </div>
                <div class="d-flex gap-2">
                  <button class="btn btn-outline-secondary btn-sm" id="news-refresh-indices-btn">Od≈õwie≈º</button>
                  <span class="badge bg-light text-muted border" id="news-indices-count">0</span>
                </div>
              </div>
              <div class="card-body">
                <div class="alert alert-danger d-none" id="news-indices-error"></div>
                <div class="table-responsive">
                  <table class="table table-hover align-middle mb-0" id="news-indices-table">
                    <thead class="table-light">
                      <tr>
                        <th scope="col">Nazwa</th>
                        <th scope="col" class="text-nowrap">Utworzono</th>
                        <th scope="col" class="text-nowrap">Rozmiar</th>
                        <th scope="col" class="text-nowrap">Status</th>
                        <th scope="col" class="text-nowrap">Akcje</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td colspan="5" class="text-center text-muted py-4">Brak danych.</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="news-overlay d-none" id="news-file-overlay">
        <div class="news-overlay__backdrop"></div>
        <div class="news-overlay__panel">
          <div class="d-flex justify-content-between align-items-start mb-3">
            <div>
              <p class="text-uppercase text-muted fs-6 mb-1">PodglƒÖd pliku</p>
              <h3 class="h5 mb-0" id="news-overlay-title">‚Äî</h3>
              <div class="small text-muted" id="news-overlay-meta">‚Äî</div>
            </div>
            <button class="btn btn-outline-secondary btn-sm" id="news-overlay-close-btn">Zamknij</button>
          </div>
          <div class="news-overlay__content" id="news-overlay-content">
            <div class="text-center text-muted py-4">Wybierz kafelek, aby zobaczyƒá dane.</div>
          </div>
        </div>
      </div>
    </div>

    <div class="toast-container position-fixed bottom-0 end-0 p-3" id="toast-wrapper"></div>
  </div>
{% endblock %}

{% block scripts %}
  <script src="{{ url_for('static', filename='js/dashboard.js') }}" defer></script>
{% endblock %}
